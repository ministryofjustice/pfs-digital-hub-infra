Ansible for Hub servers
=======================

This is the Ansible code for the servers that are used to run the Digital Hub.

Running Ansible
---------------

To run Ansible you will need to have this installed on your system.

#### Setup

Install SSH Pass
```
brew install https://raw.githubusercontent.com/kadwanev/bigboybrew/master/Library/Formula/sshpass.rb
```

```
ansible-galaxy install -r requirements.yml
```

#### Building a new server or rebuild

**Before running Ansible you will need to run Az login from terminal!** This will log you into Azure so you can retrive secrets. 

Secrets are managed in 
```
ansible\roles\azure\files\vault_password.sh
ansible\roles\hub-containers\files\vault_pas_matomo.sh

```

Post the terraform being run to create a new server or rebuild a server. You will need to run the Ansible with specific flags for the first time.

```
ansible-playbook --user hubuser --ask-pass -K site.yml --limit <servername>
```
The password is generated by the Terraform. If you did not save this you can obtain it from the terraform state file in the relevant Azure storage blob.

Once the command is run, Ansible will throw an error. This is due to it trying to disable the hubuser for security purposes. You will then need to run it as yourself, for example;

```
ansible-playbook --user <youruser> -K -i hosts site.yml --limit <servername>

```

Managing Users
---------------

All users are now defined in `group_vars/all.yml`

Documentation for the role used to manage this can be found here https://github.com/singleplatform-eng/ansible-users

There are currently 3 groups:

 - `admin`, For WebOps in the Digital Studio
 - `studio`,  For development teams in the Digital Studio

To apply the changes run the `site.yml` playbook as above, you can scope to the `users` tag to speed things up if you like.

```
ansible-playbook -i prod site.yml -t users --check
```

#### Day to Day Ansible

To run Ansible to make a change to the OS but not building a new server, run;
```
ansible-playbook --user <youruser> -K -i hosts site.yml --limit <servername>
```
This will pick up any updates and run them. Again making sure to run ``` az login ``` before.

### Addittional tags / environments limits

Currently these tags exists;
```
--limit 
```
- servername (any of the fqdn servers in use)
- dev ( dev server only)
- stage (stage server only)
- prod (both production servers at once)
```
ansible-playbook --tags="containers" --user <username> -K -i hosts --limit prod
```
An example of a tag just runing the containers role within Ansible. If you just wish to update the containers. These are defined in the site.yml. Others such as 
- users
- containers
- provisioning
- jnv.unattended-upgrades
- base
- azure 

