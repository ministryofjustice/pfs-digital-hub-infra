version: "3"

services:
  hub-be:
    restart: "always"
    environment:      
      FLYSYSTEM_S3_CNAME: {{ drupal_url }}
      FILE_PUBLIC_BASE_URL: {{ drupal_protocol }}://{{ drupal_url }}/sites/default/files
    volumes:
      - /mnt/pfs-prod-digital-hub-content-share/hub/sites/default/files:/var/www/html/sites/default/files

  hub-db:
    restart: "always"
    volumes:
      - /data/hub-db:/var/lib/mysql:rw

  hub-node:
     restart: "always"
     volumes:
       - /etc/docker/ldap_cert/awk.cer:/etc/ssl/certs/root-ca-base64.cer
     environment:
      - "APP_NAME={{ app_name }}"
      - "ESTABLISHMENT_NAME={{ establishment_name }}"
      - "NODE_ENV=production"
      - "DRUPAL_APP_URI={{ drupal_protocol }}://{{ drupal_url }}/sites/default/files"
      - "ENABLE_PRISON_SWITCH={{ feature_switch }}"
      - "NOMIS_API_TOKEN=${NOMIS_API_KEY}"
      - "NOMIS_API_ENDPOINT={{ NOMIS_API_ENDPOINT }}"
      - "FEATURE_NEW_DESIGNS={{ FEATURE_NEW_DESIGNS }}"
      - "MOCK_AUTH={{ MOCK_AUTH }}"
      - "FQDN={{ DOMAIN }}"
      - "DOMAIN_CONTROLLER={{ DOMAIN }}" # can be removed once we merge LDAP
      - "PHONE_SERVER=${PHONE_SERVER}"
      - "PHONE_PORT=${PHONE_PORT}"
      - "PHONE_PASSPHRASE=${PHONE_PASSPHRASE}"
      - "PHONE_ITERATIONS=${PHONE_ITERATIONS}"
      - "PHONE_SALT=${PHONE_SALT}"
      - "PHONE_IV=${PHONE_IV}"
      - "LDAP_URL=${LDAP_URL}"
      - "LDAP_ADMIN_DN=${LDAP_ADMIN_DN}"
      - "LDAP_ADMIN_PWD=${LDAP_ADMIN_PWD}"
      - "LDAP_USER_SEARCH_BASE=${LDAP_USER_SEARCH_BASE}"
      - "LDAP_START_TLS={{ LDAP_START_TLS }}"
      - "LDAP_USERNAME_ATTRIBUTE={{ ldap_username_attribute }}"
      - "LDAP_CERT_PATH={{ LDAP_CERT_PATH }}"
      - "ANALYTICS_ENDPOINT={{ ANALYTICS_ENDPOINT }}"
      - "ANALYTICS_SITE_ID={{ ANALYTICS_SITE_ID }}"
      - "FEEDBACK_URL={{ FEEDBACK_URL }}"
      - "NPR_STREAM={{ npr_stream_endpoint }}"

  hub-elasticsearch:
    restart: "always"
    volumes:
      - /data/esdata:/usr/share/elasticsearch/data

  nginx: 
    volumes:
    - /etc/nginx/nginx.conf:/etc/nginx/nginx.conf
    {{ nginx_config_crt }}
    {{ nginx_config_rsa }}
    - /etc/nginx/logs:/var/log/nginx:rw
    - /var/cache/nginx:/var/cache/nginx:rw
    - /data/certbot/conf:/etc/letsencrypt
    - /data/certbot/www:/var/www/certbot

  certbot:
    volumes:
    - /data/certbot/conf:/etc/letsencrypt
    - /data/certbot/www:/var/www/certbot

  cadvisor:
    restart: "always"
    volumes:
    - /:/rootfs:ro
    - /var/run:/var/run:rw
    - /sys:/sys:ro
    - /var/lib/docker/:/var/lib/docker:ro
