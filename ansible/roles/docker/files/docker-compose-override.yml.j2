version: "3"

services:
  hub-be:
    restart: "always"
    environment:
      HUB_EXT_FILE_URL: {{ drupal_url }}
    volumes:
      - /mnt/pfs-prod-digital-hub-content-share/hub/sites/default/files:/var/www/html/sites/default/files

  hub-db:
    restart: "always"
    volumes:
      - /data/hub-db:/var/lib/mysql:rw

  hub-node:
     restart: "always"
     environment:
      - "APP_NAME={{ app_name }}"
      - "ESTABLISHMENT_NAME={{ establishment_name }}"
      - "NODE_ENV=production"
      - "DRUPAL_APP_URI={{ drupal_url }}"
      - "MATOMO_URL={{ matomo_url }}"
      - "MATOMO_TOKEN=b0eba0766f3787a98c84a772de5edaf1"
      - "MATOMO_API_URI=http://hub-matomo"
      - "ENABLE_PRISON_SWITCH={{ feature_switch }}"
      - "NOMIS_API_TOKEN=${NOMIS_API_KEY}"
      - "NOMIS_API_ENDPOINT={{ NOMIS_API_ENDPOINT }}"
      - "FEATURE_NEW_DESIGNS={{ FEATURE_NEW_DESIGNS }}"
      - "MOCK_AUTH={{ MOCK_AUTH }}"
      - "FQDN={{ DOMAIN }}"
      - "DOMAIN_CONTROLLER={{ DOMAIN }}"
      - "PHONE_SERVER={{ PHONE_SERVER }}"
      - "PHONE_PORT={{ PHONE_PORT }}"
      - "PHONE_PASSPHRASE={{ PHONE_PASSPHRASE }}"
      - "PHONE_ITERATIONS={{ PHONE_ITERATIONS }}"
      - "PHONE_SALT={{ PHONE_SALT }}"
      - "PHONE_IV={{ PHONE_IV }}"
      - "LDAP_URL=${LDAP_URL}"
      - "LDAP_ADMIN_DN=${LDAP_ADMIN_DN}"
      - "LDAP_ADMIN_PWD=${LDAP_ADMIN_PWD}"
      - "LDAP_USER_SEARCH_BASE="${LDAP_USER_SEARCH_BASE}"
      - "LDAP_START_TLS={{ LDAP-START-TLS }}"

  hub-elasticsearch:
    restart: "always"
    volumes:
      - /data/esdata:/usr/share/elasticsearch/data

      
  hub-matomo:
    restart: "always"
    volumes:
      - /data/moj_dhub_matomo_config:/var/www/html/config:rw

  hub-matomo-db:
    restart: "always"
    volumes:
      - /data/moj_dhub_matomo_db/var/lib/mysql/:/var/lib/mysql/

  nginx: 
    volumes:
    - /etc/nginx/nginx.conf:/etc/nginx/nginx.conf
    - /etc/nginx/san.digital-hub.crt:/etc/letsencrypt/live/localhost/san.digital-hub.crt
    - /etc/nginx/san.digital-hub.rsa:/etc/letsencrypt/live/localhost/san.digital-hub.rsa
    - /etc/nginx/logs:/var/log/nginx:rw
    - /var/cache/nginx:/var/cache/nginx:rw
    - /data/certbot/conf:/etc/letsencrypt
    - /data/certbot/www:/var/www/certbot

  certbot:
    volumes:
    - /data/certbot/conf:/etc/letsencrypt
    - /data/certbot/www:/var/www/certbot

  cadvisor:
    volumes:
    - /:/rootfs:ro
    - /var/run:/var/run:rw
    - /sys:/sys:ro
    - /var/lib/docker/:/var/lib/docker:ro
